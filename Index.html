<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABHI MODS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- CORE STYLES & VARIABLES --- */
        :root {
            --bg-dark: #0f0f12; 
            --card-dark: #1e1e24; 
            --accent-neon: #00e6e6; /* Vibrant Cyan */
            --accent-faded: #007777;
            --text-light: #f0f0f5;
            --text-faded: #a0a0c0;
            --input-bg: #282830;
            --font-family: 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --button-radius: 6px; 
            --card-radius: 10px; 
            --gold-color: #ffd700; /* Original Gold color */
            --balance-color: #ffff33; /* NEW Brighter Yellow for Balance */
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: flex;
            flex-direction: column; 
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
        }

        .app-container {
            width: 100%;
            max-width: 360px;
            position: relative; 
            padding: 10px;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        /* --- ANIMATED LOGIN PANEL CONTAINER --- */
        #login-panel {
            padding: 0; 
            text-align: center;
            background-color: transparent;
            box-shadow: none;
            border: none;
        }

        .login-box-container {
            position: relative;
            background-color: var(--card-dark);
            border-radius: var(--card-radius);
            padding: 25px 15px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
            border: solid 2px transparent;
            background-clip: padding-box;
        }
        
        .login-box-container::before {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: -1;
            margin: -2px; 
            border-radius: calc(var(--card-radius) + 2px);
            background: linear-gradient(45deg, #ff00cc, #3333ff, #00ffcc, #ff00cc);
            background-size: 400% 400%;
            animation: border-spin 4s linear infinite;
        }
        
        @keyframes border-spin {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- LOGIN ELEMENTS --- */
        .login-logo {
            color: var(--accent-neon);
            font-size: 3em; 
            margin-bottom: 5px;
            animation: pulse-neon 2s infinite alternate;
        }
        @keyframes pulse-neon {
            0% { text-shadow: 0 0 5px var(--accent-neon), 0 0 10px var(--accent-neon), 0 0 20px #000; }
            100% { text-shadow: 0 0 10px var(--accent-neon), 0 0 20px #00ffff, 0 0 30px #00ffff; }
        }
        
        .login-input-group {
            margin-bottom: 25px; /* INCREASED SPACE HERE */
            text-align: left;
            position: relative;
        }
        .login-input {
            width: 100%;
            padding: 12px 10px 12px 35px; 
            border: 1px solid #333;
            border-radius: var(--button-radius);
            background-color: var(--input-bg);
            color: var(--text-light);
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .input-icon {
            position: absolute;
            top: 12px; 
            left: 10px;
            color: var(--accent-neon);
            font-size: 0.9em;
            z-index: 10;
        }
        
        /* --- DASHBOARD ELEMENTS --- */
        .dashboard-header {
            display: flex;
            flex-direction: column;
            padding: 10px;
            margin-bottom: 15px;
            background-color: var(--card-dark);
            border-radius: var(--card-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        /* UPDATED BALANCE CHIP STYLE, COLOR & ANIMATION */
        .balance-chip {
            padding: 8px 15px; 
            font-size: 1.0em; 
            border-radius: 6px;
            background-color: var(--balance-color); /* Bright Yellow */
            color: var(--bg-dark); /* Dark text on gold */
            font-weight: 700;
            box-shadow: 0 0 10px rgba(255, 255, 51, 0.6); /* Initial, brighter shadow */
            transition: transform 0.2s, box-shadow 0.5s;
            animation: pulse-balance 2s infinite alternate; /* NEW Animation */
        }
        
        @keyframes pulse-balance {
            0% {
                box-shadow: 0 0 5px var(--balance-color), 0 0 10px rgba(255, 255, 51, 0.4);
            }
            100% {
                box-shadow: 0 0 15px var(--balance-color), 0 0 30px rgba(255, 255, 51, 0.8);
            }
        }

        /* --- GENERAL CARD/DASHBOARD STYLES --- */
        .card {
            background-color: var(--card-dark);
            border-radius: var(--card-radius); 
            padding: 15px; 
            margin-bottom: 10px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
            border: 1px solid #33333e;
        }
        .primary-button {
            background-color: var(--accent-neon);
            color: var(--bg-dark);
            border: none;
            padding: 12px; 
            border-radius: var(--button-radius);
            width: 100%;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .primary-button:hover:not(:disabled) {
            background-color: #00ffff;
        }
        .primary-button:disabled {
            background-color: #444;
            color: #888;
            cursor: not-allowed;
        }
        
        /* --- FOOTER STYLES (UPDATED SIZE) --- */
        .app-footer {
            margin-top: 20px;
            padding: 10px;
            text-align: center;
            font-size: 0.85em; /* Increased size */
            color: var(--text-faded);
        }
        .app-footer a {
            color: #25D366; /* WhatsApp Green */
            text-decoration: none;
            font-weight: bold;
            transition: color 0.2s;
        }
        .app-footer a:hover {
            color: #34E77B;
        }
        .app-footer a i {
            font-size: 1.3em; /* Increased WhatsApp icon size */
        }

        /* --- REST OF THE STYLES --- */
        .bottom-nav-bar {
            display: flex;
            justify-content: space-around;
            background-color: var(--card-dark);
            border-radius: var(--card-radius);
            padding: 10px 0;
            margin-bottom: 10px; 
            border: 1px solid #33333e; 
            box-shadow: 0 2 pixels 6 pixels rgba(0, 0, 0, 0.5); 
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-faded);
            cursor: pointer;
            transition: color 0.2s;
            font-size: 0.75em; 
            padding: 2px;
        }
        .nav-item i {
            font-size: 1.2em;
            margin-bottom: 3px;
        }
        .nav-item.active {
            color: var(--accent-neon);
        }
        .form-group { margin-bottom: 10px; } 
        .form-group label { 
            font-size: 0.8em; 
            display: block; 
            margin-bottom: 4px;
            color: var(--text-faded);
        }
        input[type="text"], input[type="number"], input[type="password"], select, textarea {
            padding: 8px; 
            font-size: 0.9em;
            width: 100%;
            box-sizing: border-box;
            border-radius: var(--button-radius);
            background-color: var(--input-bg);
            border: 1px solid #333;
            color: var(--text-light);
            resize: vertical;
        }
        .utility-button {
            padding: 8px;
            font-size: 0.85em;
            border-radius: var(--button-radius);
            cursor: pointer;
            border: none;
            width: 100%;
            margin-top: 5px;
        }
        .utility-button.blue { background-color: #1a5c96; color: white; }
        .utility-button.green { background-color: #4CAF50; color: white; }
        .utility-button.red { background-color: #d32f2f; color: white; }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8em;
        }
        .data-table th, .data-table td {
            padding: 6px; 
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .data-table th {
            background-color: #282830;
            color: var(--accent-neon);
            font-weight: 600;
        }
        .admin-section-header {
            color: var(--accent-neon);
            border-bottom: 1px solid var(--accent-faded);
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.1em;
            font-weight: 600;
        }
        .admin-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .summary-box {
            background-color: #18181f;
            padding: 12px;
            border-left: 3px solid var(--accent-neon);
            border-radius: 6px;
        }
        .summary-box h4 {
            margin: 0 0 5px 0;
            font-size: 0.8em;
            color: var(--text-faded);
        }
        .summary-box p {
            margin: 0;
            font-size: 1.4em;
            font-weight: bold;
            color: var(--text-light);
        }

    </style>
</head>
<body>
    <div id="global-status-message" aria-live="polite"></div>

    <div class="app-container">
        
        <div id="login-panel">
            <div class="login-box-container">
                <div class="login-logo">
                    <i class="fas fa-crown"></i>
                </div>
                <h1 style="margin: 5px 0 0; font-size: 1.4em; color: var(--accent-neon);">ABHIMODS SHOP</h1>
                <p style="color: var(--text-faded); font-size: 0.7em; margin-bottom: 25px;">Secure Access</p>
                
                <div class="login-input-group">
                    <i class="input-icon fas fa-envelope"></i>
                    <input type="text" id="email" class="login-input" placeholder="Email Address" value="">
                </div>
                
                <div class="login-input-group">
                    <i class="input-icon fas fa-lock"></i>
                    <input type="password" id="password" class="login-input" placeholder="Password" value="">
                </div>
                
                <button class="primary-button" id="auth-button" onclick="handleAuth()">
                    <i class="fas fa-sign-in-alt"></i> LOGIN
                </button>
                <p id="auth-status" style="color: #d32f2f; font-size: 0.75em; margin-top: 10px; display: none;">Authentication Status</p>

                <div style="margin-top: 25px; border-top: 1px solid #333; padding-top: 15px;">
                    <p style="color: var(--text-faded); font-size: 0.7em; margin-bottom: 10px;">Contact Support:</p>
                    <div style="display: flex; justify-content: center; gap: 20px;">
                        
                        <a href="javascript:void(0)" target="_blank" style="color: #00e6e6; text-decoration: none; font-weight: bold; font-size: 0.85em;">
                            <i class="fab fa-telegram-plane"></i> Telegram
                        </a>
                        
                        <a href="javascript:void(0)" target="_blank" style="color: #25D366; text-decoration: none; font-weight: bold; font-size: 0.85em;">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </a>
                    </div>
                </div>
                </div>
        </div>

        <div id="dashboard-view" style="display: none;">
            
            <div class="dashboard-header">
                <div class="header-top">
                    <div class="welcome-text">
                        <small style="color: var(--text-faded);">Logged in as</small>
                        <h2 id="welcome-user" style="margin: 0; font-size: 1.3em;">UGABHII</h2>
                    </div>
                    <div class="balance-chip">
                        $ <span id="current-credit">0.00</span>
                    </div>
                </div>
                <button class="utility-button" onclick="logoutUser()" style="background-color: #444; color: var(--text-light); margin-top: 5px;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <div class="bottom-nav-bar" id="bottom-nav-bar" style="display:none;">
                
                <div id="admin-nav-group" style="display:none; width: 100%; display: flex; justify-content: space-around;">
                     <div class="nav-item active" 
                         data-tab="admin-dashboard-card" 
                         onclick="showDashboardContent('admin-dashboard-card', this)">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </div>
                    <div class="nav-item" 
                         data-tab="admin-reseller-card" 
                         onclick="showDashboardContent('admin-reseller-card', this)">
                        <i class="fas fa-users"></i> Resellers
                    </div>
                    <div class="nav-item" 
                         data-tab="admin-product-card" 
                         onclick="showDashboardContent('admin-product-card', this)">
                        <i class="fas fa-tags"></i> Products
                    </div>
                    <div class="nav-item" 
                         data-tab="admin-key-pool-card" 
                         onclick="showDashboardContent('admin-key-pool-card', this)">
                        <i class="fas fa-key"></i> Keys
                    </div>
                </div>
                
                <div id="reseller-nav-group" style="display:none; width: 100%; display: flex; justify-content: space-around;">
                    <div class="nav-item active" 
                         data-tab="key-generator-card" 
                         onclick="showDashboardContent('key-generator-card', this)">
                        <i class="fas fa-bolt"></i> Generate
                    </div>
                    <div class="nav-item" 
                         data-tab="keys-breakdown-card" 
                         onclick="showDashboardContent('keys-breakdown-card', this)">
                        <i class="fas fa-chart-bar"></i> Breakdown
                    </div>
                    <div class="nav-item" 
                         data-tab="key-history-card" 
                         onclick="showDashboardContent('key-history-card', this)">
                        <i class="fas fa-history"></i> History
                    </div>
                    <div class="nav-item" 
                         data-tab="credit-history-card" 
                         onclick="showDashboardContent('credit-history-card', this)">
                        <i class="fas fa-exchange-alt"></i> Ledger
                    </div>
                </div>
            </div>

            <div class="dashboard-content-area">
                
                <div class="card" id="admin-dashboard-card" style="display: none;">
                    <h3 class="admin-section-header"><i class="fas fa-tachometer-alt"></i> GLOBAL SUMMARY</h3>
                    
                    <div class="admin-summary-grid">
                        <div class="summary-box">
                            <h4>TOTAL RESELLERS</h4>
                            <p id="total-resellers">0</p>
                        </div>
                        <div class="summary-box">
                            <h4>TOTAL ACTIVE KEYS</h4>
                            <p id="total-active-keys">0</p>
                        </div>
                        <div class="summary-box">
                            <h4>TOTAL KEY SALES</h4>
                            <p id="total-sales">0</p>
                        </div>
                        <div class="summary-box">
                            <h4>AVAILABLE CREDIT</h4>
                            <p id="total-available-credit">$0.00</p>
                        </div>
                    </div>
                    
                    <h3 class="admin-section-header" style="margin-top: 20px;"><i class="fas fa-link"></i> CONTACT LINK SETTINGS</h3>
                    <div class="form-group">
                        <label for="admin-whatsapp-link">WhatsApp</label>
                        <input type="text" id="admin-whatsapp-link" placeholder="WhatsApp URL">
                    </div>
                    <div class="form-group">
                        <label for="admin-telegram-link">Telegram</label>
                        <input type="text" id="admin-telegram-link" placeholder="Telegram URL">
                    </div>
                    <button class="primary-button blue" onclick="saveContactLinks()">
                        <i class="fas fa-save"></i> Save Contact Links
                    </button>
                    <h3 class="admin-section-header" style="margin-top: 20px;"><i class="fas fa-exchange-alt"></i> RECENT TRANSACTIONS (ALL)</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>USER</th>
                                <th>TYPE</th>
                                <th>AMOUNT</th>
                            </tr>
                        </thead>
                        <tbody id="admin-all-transactions-body">
                            <tr><td colspan="3" style="text-align: center; color: var(--text-faded);">Loading logs...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="card" id="admin-reseller-card" style="display: none;">
                    <h3 class="admin-section-header"><i class="fas fa-user-plus"></i> ADD NEW RESELLER</h3>
                    <div class="form-group">
                        <input type="text" id="new-reseller-email" placeholder="New Reseller Email">
                    </div>
                    <div class="admin-form-row">
                        <div class="form-group">
                            <input type="password" id="new-reseller-password" placeholder="Password (min 6 chars)">
                        </div>
                        <div class="form-group">
                            <input type="number" id="new-reseller-credit" value="0.00" step="0.01" placeholder="Initial Credit">
                        </div>
                    </div>
                    <button class="primary-button green" onclick="addReseller()">
                        <i class="fas fa-user-plus"></i> CREATE RESELLER ACCOUNT
                    </button>
                    
                    <h4 class="admin-section-header" style="margin-top: 20px;"><i class="fas fa-user-edit"></i> MANAGE CREDIT / DELETE</h4>
                    <div class="form-group">
                        <label for="admin-user-id">TARGET RESELLER EMAIL/UID:</label>
                        <input type="text" id="admin-user-id" placeholder="Enter email or UID to modify">
                    </div>
                    <div class="admin-form-row">
                        <div class="form-group">
                            <label for="admin-credit-amount">AMOUNT ($):</label>
                            <input type="number" id="admin-credit-amount" value="10.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="utility-button blue" onclick="updateUserCredit('credit')">
                                <i class="fas fa-plus"></i> Credit
                            </button>
                        </div>
                    </div>
                    <button class="utility-button red" onclick="deleteReseller()">
                        <i class="fas fa-user-times"></i> Delete Reseller (Wipe Data)
                    </button>
                </div>

                <div class="card" id="admin-product-card" style="display: none;">
                    <h4 class="admin-section-header"><i class="fas fa-tags"></i> ADD/EDIT PRODUCT PRICE</h4>
                    <div class="form-group">
                        <label for="admin-product-name">PRODUCT DISPLAY NAME:</label>
                        <input type="text" id="admin-product-name" placeholder="e.g., NEW CHEAT">
                    </div>
                    <div class="admin-form-row">
                        <div class="form-group">
                            <label for="admin-product-days">DAYS:</label>
                            <input type="number" id="admin-product-days" value="30" min="1">
                        </div>
                        <div class="form-group">
                            <label for="admin-product-price">RESELLER PRICE ($):</label>
                            <input type="number" id="admin-product-price" value="15.00" step="0.01" min="0.01">
                        </div>
                    </div>
                    <button class="primary-button blue" onclick="addProductPrice()">
                        <i class="fas fa-save"></i> Save/Update Product Price
                    </button>
                    <button class="utility-button red" style="margin-top: 10px;" onclick="deleteProductPrice()">
                        <i class="fas fa-trash-alt"></i> Delete Selected Product/Price
                    </button>
                    
                    <h4 class="admin-section-header" style="margin-top: 20px;"><i class="fas fa-list-ul"></i> CURRENT PRICES</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PRODUCT</th>
                                <th>DAYS</th>
                                <th>PRICE</th>
                            </tr>
                        </thead>
                        <tbody id="admin-product-list">
                            <tr><td colspan="3" style="text-align: center; color: var(--text-faded);">Loading prices...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card" id="admin-key-pool-card" style="display: none;">
                    <h4 class="admin-section-header"><i class="fas fa-key"></i> MANUAL KEY POOL MANAGEMENT</h4>
                    <div class="form-group">
                        <label for="admin-key-product">TARGET PRODUCT PRICE:</label>
                        <select id="admin-key-product">
                            <option value="">Select Product...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-key-input">ADD KEYS (One per line):</label>
                        <textarea id="admin-key-input" rows="3" placeholder="KEY-1234-ABCD&#10;KEY-5678-EFGH"></textarea>
                    </div>
                    <button class="primary-button green" onclick="addKeysToPool()">
                        <i class="fas fa-plus-circle"></i> Add Keys to Pool
                    </button>
                    <button class="utility-button red" style="margin-top: 10px;" onclick="deleteAllKeysForProduct()">
                        <i class="fas fa-trash-alt"></i> Delete ALL Available Keys for Selected Product
                    </button>
                </div>

                <div class="card" id="key-generator-card" style="display: none;">
                    <h3 style="font-size: 1.1em; color: var(--text-light); border-bottom: 1px solid #333; padding-bottom: 5px; margin-top: 0; margin-bottom: 10px;">Generate Keys</h3>
                    
                    <div class="form-group">
                        <label for="product-select">PRODUCT TYPE:</label>
                        <select id="product-select" onchange="updateValidityOptions(); updateTotalCost()">
                            <option value="">Loading Products...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="validity-select">VALIDITY & COST:</label>
                        <select id="validity-select" onchange="updateTotalCost()">
                            <option value="">Select a Product First</option>
                        </select>
                        <p id="cost-display" style="text-align: right; font-weight: bold; margin-top: 5px; color: var(--text-faded); font-size: 0.75em;">
                            Total Cost: <span style="color: var(--accent-neon);">$0.00</span>
                        </p>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity">QUANTITY:</label>
                        <div class="quantity-group" style="display: flex; gap: 5px;">
                            <button onclick="updateQuantity(-1)" style="background-color: #333; color: var(--text-light); border: none; padding: 8px; width: 30px; border-radius: 4px; cursor: pointer;">-</button>
                            <input type="number" id="quantity" value="1" min="1" onchange="updateTotalCost()" style="flex-grow: 1; text-align: center;">
                            <button onclick="updateQuantity(1)" style="background-color: #333; color: var(--text-light); border: none; padding: 8px; width: 30px; border-radius: 4px; cursor: pointer;">+</button>
                        </div>
                    </div>
                    
                    <button class="primary-button" id="generate-button" onclick="generateKeys()">
                        <i class="fas fa-bolt"></i> GENERATE LICENSE KEY(S)
                    </button>

                    <div id="key-output-container" style="padding: 10px; margin-top: 15px; background-color: #18181f; border-radius: 6px; min-height: 50px; max-height: 150px; overflow-y: auto;">
                        <p style="color: var(--text-faded); text-align: center; margin: 0; font-size: 0.8em;">Generated keys will appear here.</p>
                    </div>
                </div>

                <div class="card" id="keys-breakdown-card" style="display: none;">
                    <div class="header-top">
                        <h3 style="margin: 0; font-size: 1.1em;">All Time Total Sold:</h3>
                        <div class="balance-chip" id="total-sold-display" style="background-color: #444;">0</div>
                    </div>
                    <h4 style="font-size: 1em; color: var(--accent-neon); margin-top: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;">Product Breakdown</h4>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>PRODUCT</th>
                                <th>SOLD</th>
                            </tr>
                        </thead>
                        <tbody id="breakdown-body">
                            <tr><td colspan="2" style="text-align: center; color: var(--text-faded);">Data loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="card" id="key-history-card" style="display: none;">
                    <h3 style="font-size: 1.1em; color: var(--text-light); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">Key History (All Keys)</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>KEY ID</th>
                                    <th>PRODUCT</th>
                                    <th>DAYS</th>
                                    <th>DATE</th>
                                </tr>
                            </thead>
                            <tbody id="key-history-body">
                                <tr><td colspan="4" style="text-align: center; color: var(--text-faded);">Loading history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" id="credit-history-card" style="display: none;">
                    <h3 style="font-size: 1.1em; color: var(--text-light); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 5px;">Transaction Log</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>DATE & TIME</th>
                                    <th>TYPE</th>
                                    <th>AMOUNT</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-history-body">
                                <tr><td colspan="3" style="text-align: center; color: var(--text-faded);">Loading transactions...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div> 
            
        </div>
        
    </div>
    
    <footer class="app-footer">
        Developed by <a href="javascript:void(0)" target="_blank">
            <i class="fab fa-whatsapp"></i>
        </a>
    </footer>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, runTransaction, writeBatch, deleteDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const appId = 'aimbot-af553';
    const firebaseConfig = {
      apiKey: "AIzaSyB5z9nvBFBZJsLMIJdTOR48XdPzneYjX88",
      authDomain: "aimbot-af553.firebaseapp.com",
      databaseURL: "https://aimbot-af553-default-rtdb.firebaseio.com",
      projectId: "aimbot-af553",
      storageBucket: "aimbot-af553.firebasestorage.app",
      messagingSenderId: "20838612125",
      appId: "1:20838612125:web:f886a37f1fb97861f56874",
      measurementId: "G-7S1XN5BWGM"
    };
    
    // --- ADMIN EMAIL CONSTANT (Used for Role Check) ---
    const ADMIN_EMAIL = 'admin@gmail.com'; 

    let app, db, auth;
    let currentUserId = null;
    let userProfile = { role: 'reseller', credit: 0.00, email: 'loading...', uid: null, username: 'UGABHII' };
    
    // Real-time data storage
    let productPrices = [];
    let keyHistoryData = [];
    let transactionData = [];
    let allTransactionData = []; // For Admin Dashboard
    let allResellers = [];       // For Admin Reseller Management
    let breakdownData = {}; 
    let totalKeysSold = 0;
    let contactLinks = { whatsapp: 'https://wa.me/917234884468', telegram: 'https://t.me/aimbotpap' }; // Store contact links
    
    // --- FIREBASE PATHS & SETUP ---
    const getProfileRef = (uid) => doc(db, `/artifacts/${appId}/users/${uid}/user_data/profile`);
    const getUsersCollection = () => collection(db, `/artifacts/${appId}/users`); 
    const getKeysCollection = () => collection(db, `/artifacts/${appId}/public/data/keys`);
    const getProductsCollection = () => collection(db, `/artifacts/${appId}/public/data/products`);
    const getTransactionsCollection = (uid) => collection(db, `/artifacts/${appId}/users/${uid}/transaction_log`);
    const getContactLinksRef = () => doc(db, `/artifacts/${appId}/public/data/config/contact_links`); // NEW CONFIG PATH
    

    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase Initialization Error:", e);
            showStatusMessage("Firebase failed to initialize. Check config.", 'error');
            return;
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                
                document.getElementById('auth-status').style.display = 'none';
                
                setupListeners(currentUserId);
                setupInitialData();

                document.getElementById('login-panel').style.display = 'none';
                document.getElementById('dashboard-view').style.display = 'block';
                document.getElementById('bottom-nav-bar').style.display = 'flex';
                
            } else {
                currentUserId = null;
                document.getElementById('login-panel').style.display = 'block';
                document.getElementById('dashboard-view').style.display = 'none';
                document.getElementById('bottom-nav-bar').style.display = 'none';
                
                updateProfileUI(); 
            }
        });
    }

    // --- AUTHENTICATION HANDLERS ---
    
    async function handleAuth() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const authButton = document.getElementById('auth-button');
        const statusBox = document.getElementById('auth-status');

        if (!email || !password) {
            statusBox.textContent = 'Please enter both email and password.';
            statusBox.style.display = 'block';
            return;
        }

        authButton.disabled = true;
        authButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> LOGGING IN...`;
        statusBox.style.display = 'none';

        try {
            await signInWithEmailAndPassword(auth, email, password);
            authButton.innerHTML = `<i class="fas fa-check"></i> SUCCESS`;
            authButton.style.backgroundColor = '#4CAF50';
        } catch (error) {
            console.error("Login failed:", error);
            statusBox.textContent = `Login failed: Invalid credentials or account error.`;
            statusBox.style.display = 'block';
            authButton.style.backgroundColor = 'var(--accent-neon)';
            authButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> LOGIN`;
        } finally {
            setTimeout(() => {
                authButton.disabled = false;
                if (!auth.currentUser || auth.currentUser.email !== email) { 
                     authButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> LOGIN`;
                }
            }, 1000);
        }
    }
    window.handleAuth = handleAuth;
    
    function logoutUser() {
        signOut(auth).then(() => {
            showStatusMessage('Logged out successfully.', 'success');
        }).catch((error) => {
            console.error("Logout failed:", error);
            showStatusMessage('Logout failed.', 'error');
        });
    }
    window.logoutUser = logoutUser;
    
    // --- UTILITIES ---
    function showStatusMessage(message, type = 'success', duration = 3000) {
        const statusBox = document.getElementById('global-status-message');
        const color = type === 'error' ? '#d32f2f' : (type === 'success' ? '#4CAF50' : '#FFC107');
        
        statusBox.style.cssText = `
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(20px); 
            padding: 10px 20px; border-radius: 6px; font-weight: bold; z-index: 1000;
            opacity: 0; transition: opacity 0.5s, transform 0.3s; pointer-events: none;
            min-width: 200px; text-align: center;
            background-color: ${color};
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        `;
        
        statusBox.textContent = message;
        statusBox.style.opacity = 1;
        statusBox.style.transform = 'translateX(-50%) translateY(0)';
        
        setTimeout(() => {
            statusBox.style.opacity = 0;
            statusBox.style.transform = 'translateX(-50%) translateY(20px)';
        }, duration);
    }
    window.showStatusMessage = showStatusMessage;
    
    function showDashboardContent(tabId, element) {
        document.querySelectorAll('.dashboard-content-area > .card').forEach(card => {
            card.style.display = 'none';
        });
        document.querySelectorAll('.bottom-nav-bar .nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        document.getElementById(tabId).style.display = 'block';
        element.classList.add('active');
        
        // Load data specific to Admin tabs if selected
        if (tabId === 'admin-key-pool-card' || tabId === 'admin-product-card') {
            loadAdminKeyProductOptions();
            loadAdminProductList();
        } else if (tabId === 'admin-dashboard-card') {
            loadAdminDashboardSummary();
            loadAdminAllTransactions();
            updateContactLinksUI(); // Ensure admin inputs are populated when view opens
        } else if (tabId === 'admin-reseller-card') {
            loadAdminResellerList(); 
        }
    }
    window.showDashboardContent = showDashboardContent;

    function updateQuantity(delta) {
        const input = document.getElementById('quantity');
        let current = parseInt(input.value) || 1;
        current += delta;
        if (current < 1) current = 1;
        input.value = current;
        updateTotalCost();
    }
    window.updateQuantity = updateQuantity;
    
    function copyToClipboard(text) {
        const tempInput = document.createElement('textarea');
        tempInput.value = text;
        document.body.appendChild(tempInput);
        tempInput.select();
        try {
            document.execCommand('copy');
            showStatusMessage('Key copied to clipboard!', 'success');
        } catch (err) {
            showStatusMessage('Failed to copy key.', 'error');
        }
        document.body.removeChild(tempInput);
    }
    window.copyToClipboard = copyToClipboard; 


    // --- DATA LISTENERS ---
    function setupListeners(uid) {
        if (!db) return console.error("Firestore not initialized.");

        // 1. Profile Listener (Credit, Role, etc.)
        onSnapshot(getProfileRef(uid), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                userProfile = { 
                    uid: docSnapshot.id, 
                    role: data.email === ADMIN_EMAIL ? 'admin' : (data.role || 'reseller'), 
                    credit: parseFloat(data.credit) || 0.00, 
                    email: data.email || auth.currentUser.email,
                    username: data.username || auth.currentUser.email.split('@')[0]
                };
            }
            updateProfileUI();
            updateTotalCost();
        }, (error) => console.error("Profile snapshot error:", error));

        // 2. Products Listener (Public Data)
        onSnapshot(getProductsCollection(), (snapshot) => {
            productPrices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            loadProductOptions();
            loadAdminKeyProductOptions();
            loadAdminProductList();
        }, (error) => console.error("Products snapshot error:", error));

        // 3. Key History & Breakdown Listener 
        onSnapshot(getKeysCollection(), (snapshot) => {
            const allKeys = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), docId: doc.id }));
            
            // Filter keys for current user's history
            keyHistoryData = allKeys.filter(key => 
                userProfile.role === 'admin' || 
                (key.generatedByUid === uid && key.status !== 'AVAILABLE') // Resellers only see keys they *generated/sold*
            );
            loadKeyHistory();
            
            breakdownData = {};
            totalKeysSold = 0;
            
            const keysForSalesCount = userProfile.role === 'admin' 
                ? allKeys.filter(k => k.status !== 'AVAILABLE') // Admin counts ALL generated/sold keys
                : allKeys.filter(k => k.generatedByUid === uid && k.status !== 'AVAILABLE'); // Reseller counts keys they *generated/sold*

            keysForSalesCount.forEach(key => { 
                totalKeysSold++;
                const productKey = key.productKey;
                breakdownData[productKey] = (breakdownData[productKey] || 0) + 1;
            });
            loadBreakdown();
        }, (error) => console.error("Key History snapshot error:", error));
        
        // 4. Transaction Log Listener (for current user only)
        onSnapshot(getTransactionsCollection(uid), (snapshot) => {
            transactionData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            loadTransactionHistory();
        }, (error) => console.error("Transaction Log snapshot error:", error));
        
        // 5. Global Data Listeners (Admin Only) - Resellers and Global Transactions
        onSnapshot(getUsersCollection(), async (usersSnapshot) => {
            allResellers = usersSnapshot.docs.map(doc => ({ uid: doc.id, ...doc.data().user_data?.profile }));
            loadAdminResellerList();
            loadAdminDashboardSummary();
            
            let tempAllTransactions = [];
            for (const userDoc of usersSnapshot.docs) {
                const userUid = userDoc.id;
                const userTransactionsSnapshot = await getDocs(getTransactionsCollection(userUid));
                userTransactionsSnapshot.forEach(txDoc => {
                    tempAllTransactions.push({ 
                        ...txDoc.data(), 
                        userEmail: userDoc.data().user_data?.profile?.email || userUid,
                        id: txDoc.id 
                    });
                });
            }
            allTransactionData = tempAllTransactions;
            loadAdminAllTransactions();
            
        }, (error) => console.error("Resellers snapshot error:", error));
        
        // 6. Contact Links Listener (Public Config) - NEW
        onSnapshot(getContactLinksRef(), (docSnapshot) => {
            if (docSnapshot.exists()) {
                contactLinks = docSnapshot.data();
            }
            updateContactLinksUI();
        }, (error) => console.error("Contact Links snapshot error:", error));
    }

    function updateProfileUI() {
        document.getElementById('current-credit').textContent = userProfile.credit.toFixed(2);
        document.getElementById('welcome-user').textContent = userProfile.username;
        
        const adminGroup = document.getElementById('admin-nav-group');
        const resellerGroup = document.getElementById('reseller-nav-group');
        
        // Switch between Admin and Reseller UI
        if (userProfile.role === 'admin') {
            adminGroup.style.display = 'flex';
            resellerGroup.style.display = 'none';
            if (adminGroup.children.length > 0) showDashboardContent('admin-dashboard-card', adminGroup.children[0]);
        } else {
            adminGroup.style.display = 'none';
            resellerGroup.style.display = 'flex';
            if (resellerGroup.children.length > 0) showDashboardContent('key-generator-card', resellerGroup.children[0]);
        }
    }
    
    // Function to update all contact link elements - NEW
    function updateContactLinksUI() {
        // 1. Login Panel Links
        const whatsappLoginLink = document.querySelector('#login-panel a[href*="wa.me"]');
        const telegramLoginLink = document.querySelector('#login-panel a[href*="t.me"]');
        if (whatsappLoginLink) whatsappLoginLink.href = contactLinks.whatsapp || 'javascript:void(0)';
        if (telegramLoginLink) telegramLoginLink.href = contactLinks.telegram || 'javascript:void(0)';
        
        // 2. Footer Link
        const footerLink = document.querySelector('.app-footer a');
        if (footerLink) footerLink.href = contactLinks.whatsapp || 'javascript:void(0)';
        
        // 3. Admin Input Fields (Populate if they are currently visible)
        const whatsappAdminInput = document.getElementById('admin-whatsapp-link');
        const telegramAdminInput = document.getElementById('admin-telegram-link');
        if (whatsappAdminInput) whatsappAdminInput.value = contactLinks.whatsapp || '';
        if (telegramAdminInput) telegramAdminInput.value = contactLinks.telegram || '';
    }
    
    // Function for Admin to save contact links - NEW
    async function saveContactLinks() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');

        const whatsappLink = document.getElementById('admin-whatsapp-link').value.trim();
        const telegramLink = document.getElementById('admin-telegram-link').value.trim();

        if (!whatsappLink || !telegramLink) {
            return showStatusMessage("Both WhatsApp and Telegram links are required.", 'error');
        }
        
        if (!whatsappLink.startsWith('http') || !telegramLink.startsWith('http')) {
            return showStatusMessage("Please enter full, valid URLs (starting with http/https).", 'error');
        }

        try {
            await setDoc(getContactLinksRef(), {
                whatsapp: whatsappLink,
                telegram: telegramLink,
                timestamp: Date.now()
            });

            showStatusMessage("Contact links updated successfully.", 'success');
        } catch (error) {
            console.error("Failed to save contact links:", error);
            showStatusMessage(`Failed to save contact links: ${error.message}`, 'error');
        }
    }
    window.saveContactLinks = saveContactLinks;
    
    // --- KEY GENERATOR LOGIC (Reseller Only) ---
    function getCost(productKey, days) {
        const product = productPrices.find(p => p.key === productKey && p.days === parseInt(days));
        return product ? parseFloat(product.price) : 0;
    }

    function updateTotalCost() {
        const productKey = document.getElementById('product-select').value;
        const days = document.getElementById('validity-select').value;
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        
        const unitCost = getCost(productKey, days);
        const totalCost = unitCost * quantity;

        const costDisplay = document.getElementById('cost-display');
        const generateButton = document.getElementById('generate-button');
        
        costDisplay.innerHTML = `Total Cost: <span style="color: var(--accent-neon);">$${totalCost.toFixed(2)}</span>`;
        
        const isSufficientCredit = totalCost > 0 && totalCost - userProfile.credit <= 0.0001;
        const isProductSelected = productKey && days;
        
        generateButton.disabled = !(isSufficientCredit && isProductSelected);
    }
    window.updateTotalCost = updateTotalCost;
    
    // --- PRODUCTS & VALIDITY UI UPDATES (Reseller only) ---
    function loadProductOptions() {
        const select = document.getElementById('product-select');
        select.innerHTML = '<option value="">-- Select Product --</option>'; 
        
        const uniqueProducts = productPrices.reduce((acc, current) => {
            if (!acc.some(p => p.key === current.key)) {
                acc.push({ key: current.key, displayName: current.displayName });
            }
            return acc;
        }, []);

        uniqueProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.key;
            option.textContent = product.displayName;
            select.appendChild(option);
        });

        updateValidityOptions();
    }

    function updateValidityOptions() {
        const productKey = document.getElementById('product-select').value;
        const select = document.getElementById('validity-select');
        select.innerHTML = '<option value="">-- Select Validity --</option>';
        
        const validities = productPrices
            .filter(p => p.key === productKey)
            .sort((a, b) => a.days - b.days);

        validities.forEach(product => {
            const option = document.createElement('option');
            const cost = parseFloat(product.price).toFixed(2);
            option.value = product.days;
            option.textContent = `${product.days} Days ($${cost})`;
            select.appendChild(option);
        });
        
        updateTotalCost();
    }
    window.updateValidityOptions = updateValidityOptions;
    
    // --- MAIN ACTION: GENERATE KEYS (Reseller Only) ---
    // MODIFIED TO TAKE KEYS FROM ADMIN POOL INSTEAD OF RANDOMLY GENERATING THEM
    async function generateKeys() {
        const productKey = document.getElementById('product-select').value;
        const days = parseInt(document.getElementById('validity-select').value);
        const quantity = parseInt(document.getElementById('quantity').value) || 1;
        
        const product = productPrices.find(p => p.key === productKey && p.days === days);
        if (!product || quantity < 1 || !currentUserId) {
            return showStatusMessage("Please select a product, a validity, and a valid quantity.", 'error');
        }

        const unitCost = parseFloat(product.price);
        const totalCost = unitCost * quantity;
        
        if (totalCost > userProfile.credit) {
            return showStatusMessage(`Insufficient credit. Need $${totalCost.toFixed(2)}.`, 'error');
        }

        const generateButton = document.getElementById('generate-button');
        generateButton.disabled = true;
        generateButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> PREPARING KEYS...`;

        try {
            const generatedKeys = [];
            const keysCollection = getKeysCollection();
            const profileRef = getProfileRef(currentUserId);
            let transactionSuccess = true;

            for (let i = 0; i < quantity; i++) {
                
                // --- Step 1: Find an available key in the pool ---
                // Query for ONE available key matching the product and days
                const keyQuery = query(
                    keysCollection, 
                    where("productKey", "==", productKey),
                    where("days", "==", days),
                    where("status", "==", "AVAILABLE")
                );
                
                const availableKeysSnapshot = await getDocs(keyQuery);
                if (availableKeysSnapshot.empty) {
                    // Fail the entire batch if any key is out of stock
                    transactionSuccess = false;
                    throw new Error(`Out of stock. Only ${i} key(s) generated.`);
                }
                
                const availableKeyDoc = availableKeysSnapshot.docs[0];
                const keyRef = availableKeyDoc.ref;
                const keyData = availableKeyDoc.data();
                
                const costPerKey = unitCost; 

                // --- Step 2: Use Transaction for Atomic Update ---
                await runTransaction(db, async (transaction) => {
                    // Re-read key status inside transaction to ensure no concurrent sale
                    const currentKeyDoc = await transaction.get(keyRef);
                    if (!currentKeyDoc.exists() || currentKeyDoc.data().status !== 'AVAILABLE') {
                        throw new Error(`Key ${keyData.key} was sold just now. Retrying for next key...`); // This should theoretically not happen often with the query above.
                    }
                    
                    const profileDoc = await transaction.get(profileRef);
                    if (!profileDoc.exists()) throw new Error("Profile does not exist.");

                    const currentCredit = parseFloat(profileDoc.data().credit);
                    if (currentCredit < costPerKey) throw new Error("Credit check failed during transaction.");

                    // A. Deduct Credit
                    const newCredit = currentCredit - costPerKey;
                    transaction.update(profileRef, { credit: newCredit.toFixed(2) });

                    // B. Update Key Status from AVAILABLE to GENERATED (Sold)
                    const keyUpdateData = {
                        status: 'GENERATED',
                        generatedByUid: currentUserId,
                        generatedDate: Date.now(),
                        pricePaid: costPerKey.toFixed(2) 
                    };
                    transaction.update(keyRef, keyUpdateData);
                    
                    // C. Create Transaction Log (only log the cost for one key here)
                    const transactionData = {
                        timestamp: Date.now(),
                        type: 'DEBIT',
                        amount: costPerKey.toFixed(2),
                        description: `Generated 1x ${product.displayName} (${days} days) - Key: ${keyData.key.substring(0, 8)}...`
                    };
                    transaction.set(doc(getTransactionsCollection(currentUserId)), transactionData);
                    
                    generatedKeys.push(keyData.key);
                }); // End of transaction
            } // End of quantity loop

            // Update UI with generated keys
            const keyOutputContainer = document.getElementById('key-output-container');
            keyOutputContainer.innerHTML = generatedKeys.map(key => 
                `<p style="margin: 5px 0; font-weight: bold; color: var(--accent-neon); display: flex; justify-content: space-between; align-items: center;">
                    ${key}
                    <button onclick="copyToClipboard('${key}')" style="background-color: #333; color: var(--text-light); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7em;">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </p>`
            ).join('');

            showStatusMessage(`Successfully generated ${generatedKeys.length} key(s) from pool. Credit updated.`, 'success');

        } catch (error) {
            console.error("Key generation failed:", error);
            showStatusMessage(`Generation failed: ${error.message || 'An unknown error occurred.'}`, 'error', 5000);
            
            // If some keys were generated, show partial success
            if (generatedKeys.length > 0) {
                 const keyOutputContainer = document.getElementById('key-output-container');
                 keyOutputContainer.innerHTML = generatedKeys.map(key => 
                    `<p style="margin: 5px 0; font-weight: bold; color: var(--accent-neon); display: flex; justify-content: space-between; align-items: center;">
                        ${key}
                        <button onclick="copyToClipboard('${key}')" style="background-color: #333; color: var(--text-light); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.7em;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </p>`
                ).join('') + `<p style="color: #d32f2f; text-align: center; margin: 0; font-size: 0.8em;">Partially generated. ${error.message}</p>`;
            }
        } finally {
            generateButton.disabled = false;
            generateButton.innerHTML = `<i class="fas fa-bolt"></i> GENERATE LICENSE KEY(S)`;
            updateTotalCost(); 
        }
    }
    window.generateKeys = generateKeys;

    // function generateLicenseKey() is REMOVED as requested (keys must come from pool)

    // --- HISTORY UI LOADERS (Reseller & Admin) ---
    function loadKeyHistory() {
        const historyBody = document.getElementById('key-history-body');
        historyBody.innerHTML = '';
        
        // keyHistoryData is already filtered in setupListeners
        keyHistoryData.sort((a, b) => (b.generatedDate || b.timestamp || 0) - (a.generatedDate || a.timestamp || 0)).forEach(key => {
            
            const row = historyBody.insertRow();
            const date = new Date(key.generatedDate || key.timestamp);
            row.insertCell().textContent = key.key.substring(0, 15) + (key.key.length > 15 ? '...' : ''); 
            row.insertCell().textContent = key.displayName || key.productKey; 
            row.insertCell().textContent = key.days;
            row.insertCell().textContent = date.toLocaleDateString('en-US', {month: '2-digit', day: '2-digit', year: '2-digit'}).replace(/\//g, '/');
        });
        if (keyHistoryData.length === 0) { historyBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-faded);">No key generation history found.</td></tr>'; }
    }

    function loadTransactionHistory() {
        const historyBody = document.getElementById('transaction-history-body');
        historyBody.innerHTML = '';
        
        transactionData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)).forEach(tx => {
            const row = historyBody.insertRow();
            const date = new Date(tx.timestamp || tx.date);
            const typeColor = tx.type.includes('CREDIT') ? '#4CAF50' : '#d32f2f';
            row.insertCell().innerHTML = `<strong>${date.toLocaleDateString()}</strong><br><span style="font-size: 0.8em; color: var(--text-faded);">${date.toLocaleTimeString()}</span>`;
            row.insertCell().innerHTML = `<span style="color: ${typeColor};">${tx.type}</span>`;
            const amountCell = row.insertCell();
            amountCell.textContent = `${tx.type.includes('CREDIT') ? '+' : '-'}$${parseFloat(tx.amount).toFixed(2)}`;
            amountCell.style.color = typeColor;
        });
        if (transactionData.length === 0) { historyBody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-faded);">No transaction history found.</td></tr>'; }
    }

    function loadBreakdown() {
        document.getElementById('total-sold-display').textContent = totalKeysSold;
        const body = document.getElementById('breakdown-body');
        body.innerHTML = '';

        const nameMap = productPrices.reduce((map, p) => { map[p.key] = p.displayName; return map; }, {});
        const aggregatedBreakdown = {};
        for (const key in breakdownData) {
            const displayName = nameMap[key] || key;
            aggregatedBreakdown[displayName] = (aggregatedBreakdown[displayName] || 0) + breakdownData[key];
        }
        
        const sortedKeys = Object.keys(aggregatedBreakdown).sort();

        sortedKeys.forEach(product => {
            const row = body.insertRow();
            row.insertCell().innerHTML = product;
            row.insertCell().textContent = aggregatedBreakdown[product];
        });
        
        if (sortedKeys.length === 0) { body.innerHTML = '<tr><td colspan="2" style="text-align: center; color: var(--text-faded);">No sales data to display.</td></tr>'; }
    }


    // --- ADMIN DASHBOARD & RESELLER MANAGEMENT ---
    
    // Helper to get UID from Email
    async function getUidFromEmail(email) {
        if (!email) return null;
        try {
            const q = query(getUsersCollection(), where("user_data.profile.email", "==", email));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) return snapshot.docs[0].id;
        } catch (e) {
            console.error("Failed to query UID by email:", e);
        }
        return null;
    }

    // Helper to get the target profile reference from UID or Email
    async function getTargetUserRef(input) {
        let uid = input;
        if (input.includes('@')) {
            uid = await getUidFromEmail(input);
        }
        if (uid) return getProfileRef(uid);
        return null;
    }
    
    // Admin Dashboard Summary
    function loadAdminDashboardSummary() {
        const totalCredit = allResellers.reduce((sum, r) => sum + (parseFloat(r.credit) || 0), 0);
        
        document.getElementById('total-resellers').textContent = allResellers.length;
        document.getElementById('total-active-keys').textContent = keyHistoryData.filter(k => k.status !== 'AVAILABLE').length;
        document.getElementById('total-sales').textContent = totalKeysSold;
        document.getElementById('total-available-credit').textContent = `$${totalCredit.toFixed(2)}`;
    }

    // Admin All Transactions Log
    function loadAdminAllTransactions() {
        const body = document.getElementById('admin-all-transactions-body');
        body.innerHTML = '';
        
        allTransactionData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        allTransactionData.slice(0, 10).forEach(tx => {
            const row = body.insertRow();
            const typeColor = tx.type.includes('CREDIT') ? '#4CAF50' : '#d32f2f';
            
            row.insertCell().textContent = tx.userEmail.split('@')[0];
            row.insertCell().innerHTML = `<span style="color: ${typeColor};">${tx.type}</span>`;
            row.insertCell().textContent = `${tx.type.includes('CREDIT') ? '+' : '-'}$${parseFloat(tx.amount).toFixed(2)}`;
        });
        
        if (allTransactionData.length === 0) { body.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-faded);">No global transaction logs found.</td></tr>'; }
    }

    // Admin Product List
    function loadAdminProductList() {
        const body = document.getElementById('admin-product-list');
        body.innerHTML = '';
        
        productPrices.sort((a, b) => (a.displayName || '').localeCompare(b.displayName || '') || a.days - b.days);

        productPrices.forEach(p => {
            const row = body.insertRow();
            row.insertCell().textContent = p.displayName;
            row.insertCell().textContent = p.days;
            row.insertCell().textContent = `$${parseFloat(p.price).toFixed(2)}`;
        });
        
        if (productPrices.length === 0) { body.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--text-faded);">No products defined. Add one above.</td></tr>'; }
    }


    // ADD NEW RESELLER
    async function addReseller() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');

        const email = document.getElementById('new-reseller-email').value.trim();
        const password = document.getElementById('new-reseller-password').value;
        const initialCredit = parseFloat(document.getElementById('new-reseller-credit').value) || 0;

        if (!email || !password || password.length < 6) {
            return showStatusMessage("Invalid Email or Password (min 6 chars).", 'error');
        }

        try {
            // Step 1: Create user in Firebase Authentication
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const uid = userCredential.user.uid;
            
            // Step 2: Create profile document in Firestore
            const profileRef = getProfileRef(uid);
            await setDoc(profileRef, {
                credit: initialCredit.toFixed(2),
                email: email,
                username: email.split('@')[0],
                role: 'reseller',
                timestamp: Date.now()
            });
            
            // Step 3: Log initial credit
            if (initialCredit > 0) {
                 const transactionData = {
                    timestamp: Date.now(),
                    type: 'CREDIT (Admin Add)',
                    amount: initialCredit.toFixed(2),
                    description: `Initial credit granted by Admin`
                };
                await setDoc(doc(getTransactionsCollection(uid)), transactionData);
            }
            
            showStatusMessage(`Reseller ${email} created successfully with $${initialCredit.toFixed(2)} credit.`, 'success', 5000);
            
            // Clear inputs after success
            document.getElementById('new-reseller-email').value = '';
            document.getElementById('new-reseller-password').value = '';
            document.getElementById('new-reseller-credit').value = '0.00';

        } catch (error) {
            console.error("Reseller creation failed:", error);
            let errorMessage = `Reseller creation failed: ${error.message}`;
            if (error.code === 'auth/email-already-in-use') {
                 errorMessage = `Reseller creation failed: Email already exists.`;
            } else if (error.code === 'auth/weak-password') {
                 errorMessage = `Reseller creation failed: Password is too weak (min 6 chars).`;
            }
            showStatusMessage(errorMessage, 'error', 6000);
        }
    }
    window.addReseller = addReseller;

    // UPDATE CREDIT / DELETE RESELLER
    async function updateUserCredit(type) {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');
        
        const input = document.getElementById('admin-user-id').value.trim();
        const amount = parseFloat(document.getElementById('admin-credit-amount').value);

        if (!input || isNaN(amount) || amount <= 0) {
            return showStatusMessage("Target user and a positive amount are required.", 'error');
        }
        
        const targetRef = await getTargetUserRef(input);
        if (!targetRef) {
            return showStatusMessage(`User not found for: ${input}`, 'error');
        }

        try {
            await runTransaction(db, async (transaction) => {
                const docSnap = await transaction.get(targetRef);
                if (!docSnap.exists()) throw new Error("Target user profile not found in DB.");

                const currentCredit = parseFloat(docSnap.data().credit || 0);
                let newCredit;
                
                if (type === 'credit') {
                    newCredit = currentCredit + amount;
                } else if (type === 'debit') {
                    newCredit = currentCredit - amount;
                } else {
                    throw new Error("Invalid transaction type.");
                }

                transaction.update(targetRef, { credit: newCredit.toFixed(2) });

                // Log the transaction
                const transactionData = {
                    timestamp: Date.now(),
                    type: type === 'credit' ? 'CREDIT (Admin)' : 'DEBIT (Admin)',
                    amount: amount.toFixed(2),
                    description: `Admin ${type} by ${userProfile.email}`
                };
                transaction.set(doc(getTransactionsCollection(docSnap.id)), transactionData);
            });
            showStatusMessage(`Successfully ${type}ed $${amount.toFixed(2)} to ${input}.`, 'success');
        } catch (error) {
            console.error(`Credit update failed:`, error);
            showStatusMessage(`Credit update failed: ${error.message}`, 'error');
        }
    }
    window.updateUserCredit = updateUserCredit;

    async function deleteReseller() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');
        
        const input = document.getElementById('admin-user-id').value.trim();
        if (!input) {
            return showStatusMessage("Enter the reseller's email/UID to delete.", 'error');
        }
        
        if (!confirm(`WARNING: This will delete ALL Firestore data for ${input} (profile, transactions, generated keys). You must manually delete the user from the Firebase Authentication console.`)) {
            return;
        }

        const userDocRef = await getTargetUserRef(input);
        if (!userDocRef) {
            return showStatusMessage(`User not found for: ${input}`, 'error');
        }

        const uid = userDocRef.parent.parent.id; // Extract UID from profile path

        try {
            const batch = writeBatch(db);

            // 1. Delete Profile
            batch.delete(userDocRef);

            // 2. Delete Transaction Log
            const transactionsSnapshot = await getDocs(getTransactionsCollection(uid));
            transactionsSnapshot.forEach(doc => batch.delete(doc.ref));

            // 3. Delete Generated Keys (optional, depending on your key structure)
            const keysQuery = query(getKeysCollection(), where("generatedByUid", "==", uid));
            const keysSnapshot = await getDocs(keysQuery);
            keysSnapshot.forEach(doc => batch.delete(doc.ref));
            
            // 4. Delete the user's root data collection (user_data)
            batch.delete(doc(db, `/artifacts/${appId}/users/${uid}/user_data/profile`)); 

            await batch.commit();

            showStatusMessage(`Successfully wiped ALL data for ${input}. REMEMBER to delete the user in Firebase Auth.`, 'success', 8000);
            document.getElementById('admin-user-id').value = '';

        } catch (error) {
            console.error("Reseller deletion failed:", error);
            showStatusMessage(`Data wipe failed: ${error.message}`, 'error', 6000);
        }
    }
    window.deleteReseller = deleteReseller;
    
    // PRODUCT/PRICE MANAGEMENT
    async function addProductPrice() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');
        
        const name = document.getElementById('admin-product-name').value.trim();
        const days = parseInt(document.getElementById('admin-product-days').value);
        const price = parseFloat(document.getElementById('admin-product-price').value);

        if (!name || isNaN(days) || days < 1 || isNaN(price) || price <= 0) {
            return showStatusMessage("All fields must be valid. Days must be >= 1, Price must be > 0.", 'error');
        }
        
        const productKey = name.toUpperCase().replace(/[^A-Z0-9]/g, '_');
        const docId = `${productKey}_${days}d`;

        try {
            await setDoc(doc(getProductsCollection(), docId), {
                key: productKey,
                displayName: name,
                days: days,
                price: price.toFixed(2),
                timestamp: Date.now()
            });
            showStatusMessage(`Product/Price ${name} (${days} days) saved/updated.`, 'success');
        } catch (error) {
            console.error("Failed to save product price:", error);
            showStatusMessage(`Failed to save product price: ${error.message}`, 'error');
        }
    }
    window.addProductPrice = addProductPrice;

    async function deleteProductPrice() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');
        
        const name = document.getElementById('admin-product-name').value.trim();
        const days = parseInt(document.getElementById('admin-product-days').value);
        
        if (!name || isNaN(days)) {
            return showStatusMessage("Enter the Product Name and Days to confirm deletion.", 'error');
        }
        
        const productKey = name.toUpperCase().replace(/[^A-Z0-9]/g, '_');
        const docId = `${productKey}_${days}d`;

        if (!confirm(`Are you sure you want to delete the price for ${name} (${days} days)? This action is irreversible.`)) {
            return;
        }

        try {
            await deleteDoc(doc(getProductsCollection(), docId));
            showStatusMessage(`Product/Price ${name} (${days} days) deleted.`, 'success');
        } catch (error) {
            console.error("Failed to delete product price:", error);
            showStatusMessage(`Failed to delete product price: ${error.message}`, 'error');
        }
    }
    window.deleteProductPrice = deleteProductPrice;
    
    // KEY POOL MANAGEMENT
    function loadAdminKeyProductOptions() {
        const select = document.getElementById('admin-key-product');
        const currentSelection = select.value;

        select.innerHTML = '<option value="">-- Select Product Price --</option>'; 
        
        productPrices.forEach(current => {
            const productDocId = `${current.key}_${current.days}d`;
            const option = document.createElement('option');
            option.value = productDocId;
            option.textContent = `${current.displayName} (${current.days} Days - $${parseFloat(current.price).toFixed(2)})`;
            select.appendChild(option);
        });

        if (currentSelection && select.querySelector(`option[value="${currentSelection}"]`)) {
             select.value = currentSelection;
        } else {
             select.value = '';
        }
    }
    
    async function addKeysToPool() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');
        
        const docId = document.getElementById('admin-key-product').value;
        const keyInput = document.getElementById('admin-key-input').value.trim();

        if (!docId || !keyInput) {
            return showStatusMessage("Select a product price and enter keys.", 'error');
        }

        const keys = keyInput.split('\n').map(key => key.trim()).filter(key => key.length > 0);
        if (keys.length === 0) {
            return showStatusMessage("No valid keys entered.", 'error');
        }

        const productDetail = productPrices.find(p => `${p.key}_${p.days}d` === docId);
        if (!productDetail) {
             return showStatusMessage("Selected product details not found.", 'error');
        }

        const batch = writeBatch(db);
        const keysCollection = getKeysCollection();
        let successCount = 0;

        keys.forEach(key => {
            // Use the key itself as part of the document ID to prevent duplicates if key is unique
            // Use a prefix to distinguish pooled keys from sold keys
            const keyRefDocId = `POOL_KEY_${key.replace(/[^A-Z0-9]/g, '')}`; 
            
            const keyData = {
                key: key,
                productKey: productDetail.key,
                displayName: productDetail.displayName,
                days: productDetail.days,
                price: productDetail.price,
                status: 'AVAILABLE', 
                generatedByUid: currentUserId, // Admin's UID when added to pool
                generatedDate: Date.now()
            };
            const keyRef = doc(keysCollection, keyRefDocId);
            batch.set(keyRef, keyData);
            successCount++;
        });

        try {
            await batch.commit();
            showStatusMessage(`Successfully added ${successCount} key(s) to the ${productDetail.displayName} pool.`, 'success', 5000);
            document.getElementById('admin-key-input').value = ''; 
        } catch (error) {
            console.error("Failed to add keys to pool:", error);
            showStatusMessage(`Failed to add keys to pool: ${error.message}`, 'error');
        }
    }
    window.addKeysToPool = addKeysToPool;

    async function deleteAllKeysForProduct() {
        if (userProfile.role !== 'admin') return showStatusMessage("Access Denied.", 'error');
        
        const docId = document.getElementById('admin-key-product').value;
        if (!docId) {
            return showStatusMessage("Select a product price to wipe its pool.", 'error');
        }
        
        const productDetail = productPrices.find(p => `${p.key}_${p.days}d` === docId);
        if (!productDetail) return showStatusMessage("Product details not found.", 'error');

        if (!confirm(`WARNING: Are you sure you want to delete ALL AVAILABLE keys for ${productDetail.displayName} (${productDetail.days} days)?`)) {
            return;
        }

        try {
            const q = query(
                getKeysCollection(), 
                where("productKey", "==", productDetail.key),
                where("days", "==", productDetail.days),
                where("status", "==", "AVAILABLE") 
            );
            const snapshot = await getDocs(q);
            
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();

            showStatusMessage(`Successfully deleted ${snapshot.size} AVAILABLE keys from the ${productDetail.displayName} pool.`, 'success', 5000);

        } catch (error) {
            console.error("Failed to delete key pool:", error);
            showStatusMessage(`Failed to delete key pool: ${error.message}`, 'error');
        }
    }
    window.deleteAllKeysForProduct = deleteAllKeysForProduct;


    // --- INITIAL DATA SETUP (Demo Data) ---
    async function setupInitialData() {
        const adminProfileRef = getProfileRef(auth.currentUser.uid);
        const adminProfileSnap = await getDoc(adminProfileRef);

        // Initialize admin profile if it doesn't exist
        if (auth.currentUser.email === ADMIN_EMAIL && !adminProfileSnap.exists()) {
            await setDoc(adminProfileRef, {
                credit: '99999.00',
                email: ADMIN_EMAIL,
                username: 'ABHIMODS',
                role: 'admin',
                timestamp: Date.now()
            });
            showStatusMessage("Admin profile initialized.", 'info', 2000);
        }

        // Initialize demo products if none exist
        const productsSnap = await getDocs(getProductsCollection());
        if (productsSnap.empty) {
            const batch = writeBatch(db);
            const demoProducts = [
                { key: 'STANDARD', displayName: 'Standard Cheat', days: 7, price: '5.00' },
                { key: 'STANDARD', displayName: 'Standard Cheat', days: 30, price: '15.00' },
                { key: 'PREMIUM', displayName: 'Premium Cheat', days: 7, price: '10.00' },
                { key: 'PREMIUM', displayName: 'Premium Cheat', days: 30, price: '30.00' },
            ];

            demoProducts.forEach(p => {
                const docId = `${p.key}_${p.days}d`;
                batch.set(doc(getProductsCollection(), docId), {
                    ...p,
                    timestamp: Date.now()
                });
            });
            await batch.commit();
            showStatusMessage("Demo products initialized.", 'info', 2000);
        }
        
        // Initialize contact links if not present - NEW
        const contactLinkSnap = await getDoc(getContactLinksRef());
        if (!contactLinkSnap.exists()) {
            await setDoc(getContactLinksRef(), {
                whatsapp: 'https://wa.me/917234884468',
                telegram: 'https://t.me/aimbotpap',
                timestamp: Date.now()
            });
        }
    }

    // --- STARTUP ---
    document.addEventListener('DOMContentLoaded', initializeFirebase);
</script>
</body>
</html>